# ============================================
# Patient Service Infrastructure
# ============================================

services:
  # PostgreSQL - Patient Service Database
  postgres-patient:
    image: postgres:${POSTGRES_VERSION:-16-alpine}
    container_name: postgres-patient
    restart: unless-stopped

    environment:
      POSTGRES_DB: ${PATIENT_DB_NAME:-patient_db}
      POSTGRES_USER: ${POSTGRES_USER:-hospital}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-hospital123}
      POSTGRES_INITDB_ARGS: '--encoding=UTF-8 --lc-collate=en_US.UTF-8 --lc-ctype=en_US.UTF-8'
      PGDATA: /var/lib/postgresql/data/pgdata

    env_file:
      - ../../.env

    ports:
      - '${PATIENT_DB_PORT:-5433}:5432'

    volumes:
      - postgres-patient-data:/var/lib/postgresql/data

    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${POSTGRES_USER:-hospital} -d ${PATIENT_DB_NAME:-patient_db}']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

    deploy:
      resources:
        limits:
          memory: 512m
        reservations:
          memory: 128m

    networks:
      - hospital-network

    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'

# ============================================
# Named Volumes
# ============================================
volumes:
  postgres-patient-data:
    name: hospital-postgres-patient-data
    driver: local

# ============================================
# Networks
# ============================================
networks:
  hospital-network:
    name: ${NETWORK_NAME:-hospital-network}
    driver: bridge
    external: true
